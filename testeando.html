<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compartir Pantalla</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; background: #121212; color: white; }
        button { padding: 10px; margin: 10px; cursor: pointer; font-size: 16px; }
        video { width: 80%; max-width: 600px; border: 2px solid white; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Compartir Pantalla</h1>
    <button id="startShare">Iniciar transmisión</button>
    <input type="text" id="magnetLink" placeholder="Pega el enlace aquí" style="width: 80%; padding: 5px;">
    <button id="watchShare">Ver transmisión</button>
    <div id="videos"></div>

    <script>
        const client = new WebTorrent();
        const videosDiv = document.getElementById("videos");

        document.getElementById("startShare").addEventListener("click", async () => {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const video = document.createElement("video");
            video.srcObject = stream;
            video.autoplay = true;
            videosDiv.appendChild(video);

            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) chunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const file = new Blob(chunks, { type: "video/webm" });
                client.seed(file, (torrent) => {
                    console.log("Compartiendo en:", torrent.magnetURI);
                    document.getElementById("magnetLink").value = torrent.magnetURI;
                });
            };

            mediaRecorder.start(1000); // Captura continua cada segundo
            setInterval(() => mediaRecorder.requestData(), 1000); // Evita acumulación de datos
        });

        document.getElementById("watchShare").addEventListener("click", () => {
            const magnetURI = document.getElementById("magnetLink").value;
            if (magnetURI) {
                client.add(magnetURI, (torrent) => {
                    torrent.files[0].renderTo(videosDiv);
                });
            } else {
                alert("Pegá un enlace válido.");
            }
        });
    </script>
</body>
</html>